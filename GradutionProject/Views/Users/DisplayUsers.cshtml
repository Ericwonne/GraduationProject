@model System.Data.DataTable
@{
    ViewBag.Title = "Display Users";
}
@*<link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="~/Content/htmleaf-demo.css" />
    <link rel="stylesheet" type="text/css" href="~/Content/samples-styles.css" />*@
<style type="text/css">
    td.alt {
        background-color: #ffc;
        background-color: rgba(230, 127, 34, 0.2);
    }
</style>
<body onload="loadPinyin();">
    <h2>教务管理系统的所有用户（管理员除外）</h2>
    <br />
    <div class="container">
        <div class="input-group">
            <div class="input-group-addon"><i class="fa fa-search fa-lg"></i>&nbsp;</div>
            <input class="form-control" type="search" id="input-filter" size="15" placeholder="搜索表格中的条目" />
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <small><i class="glyphicon glyphicon-question-sign" style="color:forestgreen"></i></small> 用户类型（S:学生  T:教师）
            &nbsp;&nbsp;&nbsp;&nbsp;
        </div>
        <table class="table">
            <thead>
                <tr>
                    @*@foreach (var col in Model.Columns)
                        {
                            <td>@col</td>
                        }*@
                    <th><i class="fa fa-hashtag"></i>&nbsp;姓名 </th>
                    <th><i class="fa fa-hashtag"></i>&nbsp;电子邮箱</th>
                    <th><i class="fa fa-hashtag"></i>&nbsp;注册日期</th>
                    <th><i class="fa fa-hashtag"></i>&nbsp;用户类型</th>
                    <th><i class="fa fa-hashtag"></i>&nbsp;操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (System.Data.DataRow rows in Model.Rows)
                {
                    <tr>
                        <td><a name="hiddena" style="color:blue" href="SpecificUser?id=@rows[0]">@rows[1]</a></td>
                        <td><a href="mailto:@rows[2]">@rows[2]</a></td>
                        <td>@rows[3]</td>
                        <td>@rows[4]</td>
                        <td>
                            <!--傻傻的方法 onclick="getSpecificInfo(this.parentElement.parentElement.children[0].children[0].getAttribute('href').split('=')[1])"-->
                            <button class="btn btn-link" data-toggle="modal" data-target="#myModal" onclick="getSpecificInfo('@rows[0]', '@rows[1]')">
                                管理
                            </button>
                        </td>
                        <td class="hidden"></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- 模态框（Modal） -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel"></h4>
                </div>
                <div id="modal-body" class="modal-body" style="margin-top:0">
                </div>
                <div class="modal-footer" style="margin-top:0">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitChange()">
                        提交更改
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
</body>
<script src="https://cdn.bootcss.com/jquery/3.1.1/jquery.js"></script>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script src="~/Scripts/jquery.filtertable.min.js"></script>

<script>
    //全局变量
    var initialModal = null;

    //支持搜索
    $(document).ready(function () {
        $('table').filterTable({ // apply filterTable to all tables on this page
            inputSelector: '#input-filter' // use the existing input instead of creating a new one
        });
    });

    //用来支持拼音搜索表格数据
    function loadPinyin() {
        var aList = document.getElementsByName("hiddena");
        var hiddenList = document.getElementsByClassName("hidden");

        for (var index = 0; index < aList.length; index++) {
            hiddenList[index].innerText = ConvertPinyin(aList[index].innerText);
        }
    }

    //点击【管理】按钮后向数据库请求数据动态写入Modal框
    function getSpecificInfo(id, name) {
        document.getElementById('myModalLabel').innerHTML = "修改" + name + "的信息";
        var result = "";
        $.ajax({
            type: "GET",
            url: "GetSpecificUser",
            data: "id=" + id,
            contentType: false,
            processData: false,
            async: false,               //同步: Google"如何获取Ajax的返回值,了解只有同步机制下可以获取返回值，否则获取到的就是undefined"
            success: function (response) {
                result = response;
            },
            error: function (response) {
                console.log(response);
            }
        });
        result = result.split('&');
        var one_record = "", element = "<table id='dynamic_table' class='table table-condensed'>"; // internal_initial_modal = "";

        for (var i = 0; i < result.length; i++) {
            one_record = result[i].split('=');      //one_record[0]: attribute;   one_record[1]: value;
            element += "<tr><td><label>" + one_record[0].toUpperCase() + "</label></td>" + "<td><input type='text' class='form-control' placeholder=" + one_record[1] + " /></td></tr>";
            //internal_initial_modal += one_record[1] + "&";
        }
        element += "</table>";
        var modal = document.getElementById("modal-body");
        modal.innerHTML = element;
        modal.children[0].children[0].children[0].children[1].children[0].setAttribute('disabled', '');
        //initialModal = internal_initial_modal.substr(0, internal_initial_modal.length - 1);
        initialModal = result;
    }

    //点击【提交更改】
    function submitChange() {
        //console.log(initialModal);
        //initialModal = initialModal.split('&');

        var dynamic_table_contents = document.getElementById('dynamic_table').getElementsByTagName('input');
        var ajaxData = '', tmp = '';
        //var i从1开始因为第一个数据不可改变
        for (var i = 1; i < dynamic_table_contents.length; i++) {
            //tmp = dynamic_table_contents[i].getAttribute('value');  ----which just doesn't work using getAttribute(), confusing yet.
            //Understand now: the value property of an element is updated with its current status, while getAttribute('value') is just getting its default value, which is not changed.
            tmp = dynamic_table_contents[i].value;
            if (tmp == "") {
                continue;
            }
            else if (tmp.indexOf('&') != -1) {
                alert("对不起，您修改的内容中不能含有“&”符号！");
                ajaxData = null;
                return;
            }
            else {
                ajaxData += initialModal[i].split('=')[0] + '=' + '\'' + tmp + '\'' + '&';
            }
        }

        ajaxData = ajaxData.substr(0, ajaxData.length - 1);                       //去掉最后多余的‘&’符号
        ajaxData = dynamic_table_contents[0].getAttribute('placeholder') + '&' + ajaxData;    //把uniqueclientid值传入

        alert(ajaxData);    //Test

        var parames = new Array();
        parames.push({ name: "ajaxData", value: ajaxData });

        Post("ModifySpecificUser", parames);

        //The below commented code killed me almost!
        //$.ajax({
        //    type: "POST",
        //    url: "ModifySpecificUser",
        //    data: { "ajaxData": ajaxData },
        //    contentType: false,
        //    processData: false,
        //    dataType: "text",
        //    async: false,               //同步: Google"如何获取Ajax的返回值,了解只有同步机制下可以获取返回值，否则获取到的就是undefined"
        //    success: function (response) {
        //        alert("修改成功！");
        //    },
        //    error: function (response) {
        //        console.log(response);
        //    }
        //});

        //判断值是否改变-【已弃用】
        //for (var i = 1; i < dynamic_table_contents.length; i++) {
        //    if (dynamic_table_contents[i].value == initialModal[i]) {
        //        alert(dynamic_table_contents[i].value);
        //    }
        //}
    }

    //Copied from Login.cshtml
    function Post(URL, PARAMTERS) {
        //创建form表单
        var temp_form = document.createElement("form");
        temp_form.action = URL;
        //如需打开新窗口，form的target属性要设置为'_blank'
        temp_form.target = "_self";
        temp_form.method = "post";
        temp_form.style.display = "none";
        //添加参数
        for (var item in PARAMTERS) {
            var opt = document.createElement("textarea");
            opt.name = PARAMTERS[item].name;
            opt.value = PARAMTERS[item].value;
            temp_form.appendChild(opt);
        }
        document.body.appendChild(temp_form);
        //提交数据
        temp_form.submit();
    }
</script>